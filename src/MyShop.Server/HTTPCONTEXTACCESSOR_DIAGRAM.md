# HttpContextAccessor Flow Diagram

## ?? Architecture Overview

```
???????????????????????????????????????????????????????????????????
?                         HTTP REQUEST                             ?
?                    (v?i Bearer Token)                            ?
???????????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????????
?                    ASP.NET Core Pipeline                         ?
???????????????????????????????????????????????????????????????????
?  1. Request arrives                                              ?
?  2. Create HttpContext for this request                         ?
?  3. Set HttpContext in HttpContextAccessor                      ?
???????????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????????
?              Authentication Middleware                           ?
???????????????????????????????????????????????????????????????????
?  1. Extract JWT token from Authorization header                 ?
?  2. Validate token (signature, expiry, issuer, audience)       ?
?  3. Parse claims from token                                      ?
?  4. Create ClaimsPrincipal with claims                          ?
?  5. Set HttpContext.User = ClaimsPrincipal                      ?
???????????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????????
?                      Authorization                               ?
?                   (Check [Authorize])                            ?
???????????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????????
?                      AuthController                              ?
???????????????????????????????????????????????????????????????????
?  [HttpGet("me")]                                                 ?
?  [Authorize]                                                     ?
?  public async Task<IActionResult> GetMe()                        ?
?  {                                                               ?
?      var user = await _authService.GetMeAsync();                ?
?      return Ok(user);                                            ?
?  }                                                               ?
???????????????????????????????????????????????????????????????????
                           ?
                           ?
???????????????????????????????????????????????????????????????????
?                      AuthService                                 ?
???????????????????????????????????????????????????????????????????
?  public async Task<UserInfoResponse?> GetMeAsync()               ?
?  {                                                               ?
?      // ?? Get HttpContext through accessor                     ?
?      var httpContext = _httpContextAccessor.HttpContext; ????  ?
?                                                              ?  ?
?      if (httpContext == null) return null;                  ?  ?
?                                                              ?  ?
?      // Extract userId from claims                          ?  ?
?      var userId = InfoJwtService.GetUserId(                 ?  ?
?          httpContext.User);  ?????????????????????????????  ?  ?
?                                                           ?  ?  ?
?      return await GetMeAsync(userId.Value);               ?  ?  ?
?  }                                                        ?  ?  ?
???????????????????????????????????????????????????????????????????
                                                            ?  ?
???????????????????????????????????????????????????????????????????
?              IHttpContextAccessor (Singleton)             ?  ?  ?
???????????????????????????????????????????????????????????????????
?  private AsyncLocal<HttpContext?> _httpContext;           ?  ?  ?
?                                                            ?  ?  ?
?  public HttpContext? HttpContext                          ?  ?  ?
?  {                                                         ?  ?  ?
?      get => _httpContext.Value; ???????????????????????????  ?  ?
?      set => _httpContext.Value = value;                      ?  ?
?  }                                                            ?  ?
?????????????????????????????????????????????????????????????????  ?
                                                ?                  ?
                                                ?                  ?
???????????????????????????????????????????????????????????????   ?
?              HttpContext (Per Request)                       ?   ?
???????????????????????????????????????????????????????????????   ?
?  Properties:                                                 ?   ?
?  ?? Request: HttpRequest                                     ?   ?
?  ?? Response: HttpResponse                                   ?   ?
?  ?? User: ClaimsPrincipal ???????????????????????????????????????
?  ?   ?? Claims:                                             ?
?  ?       ?? NameIdentifier: "3fa85f64..."  (User ID)       ?
?  ?       ?? Name: "john_doe"                (Username)      ?
?  ?       ?? Email: "john@example.com"       (Email)         ?
?  ?       ?? Role: ["User", "Admin"]         (Roles)         ?
?  ?       ?? authority: ["POST", "DELETE"]   (Authorities)   ?
?  ?? Connection: ConnectionInfo                               ?
?  ?? Session: ISession                                        ?
?  ?? RequestServices: IServiceProvider                        ?
???????????????????????????????????????????????????????????????
```

## ?? Data Flow Detail

### Step 1: HTTP Request v?i JWT Token
```
GET /api/v1/auth/me HTTP/1.1
Host: localhost:5228
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Step 2: ASP.NET Core t?o HttpContext
```csharp
// ASP.NET Core internally does:
var httpContext = new DefaultHttpContext
{
    Request = { /* parsed from HTTP request */ },
    Response = { /* will be built */ },
    Connection = { /* client info */ }
};

// Set vào HttpContextAccessor
_httpContextAccessor.HttpContext = httpContext;
```

### Step 3: JWT Authentication Middleware
```csharp
// Authentication middleware does:
var token = httpContext.Request.Headers["Authorization"]
    .ToString().Replace("Bearer ", "");

var claimsPrincipal = ValidateAndParseToken(token);

// Set User vào HttpContext
httpContext.User = claimsPrincipal;
```

### Step 4: AuthController g?i Service
```csharp
// In Controller
var user = await _authService.GetMeAsync();
```

### Step 5: Service access HttpContext
```csharp
// In AuthService
var httpContext = _httpContextAccessor.HttpContext;
//                 ??> Returns HttpContext c?a request hi?n t?i

var userId = InfoJwtService.GetUserId(httpContext.User);
//                                     ??> ClaimsPrincipal v?i claims t? JWT
```

## ??? Dependency Injection Setup

```
??????????????????????????????????????????????????????????
?                    Program.cs                           ?
??????????????????????????????????????????????????????????
?  builder.Services.AddHttpContextAccessor(); ????????  ?
?                                                     ?  ?
?  builder.Services.AddScoped<IAuthService,           ?  ?
?                               AuthService>(); ????  ?  ?
??????????????????????????????????????????????????????????
                                                   ?  ?
                           ?????????????????????????  ?
                           ?                          ?
                           ?                          ?
?????????????????????????????????????????????????????????
?              DI Container                          ?  ?
?????????????????????????????????????????????????????????
?  Registered Services:                              ?  ?
?                                                     ?  ?
?  IHttpContextAccessor ??? HttpContextAccessor ??????  ?
?    Lifetime: Singleton                                ?
?    Instance: 1 per application                        ?
?                                                        ?
?  IAuthService ??? AuthService                         ?
?    Lifetime: Scoped                                    ?
?    Instance: 1 per request                            ?
?    Dependencies: [IHttpContextAccessor, ...]          ?
??????????????????????????????????????????????????????????
```

## ?? AuthService Constructor Injection

```csharp
public class AuthService : IAuthService
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    
    // DI Container injects HttpContextAccessor here
    public AuthService(
        IUserRepository userRepository,
        IJwtService jwtService,
        IRoleRepository roleRepository,
        ILogger<AuthService> logger,
        IHttpContextAccessor httpContextAccessor) ???? Injected
    {
        _httpContextAccessor = httpContextAccessor;
        // Store reference for later use
    }
}
```

## ?? JWT Claims trong HttpContext.User

```
HttpContext.User (ClaimsPrincipal)
?? Identity
?  ?? IsAuthenticated: true
?  ?? AuthenticationType: "Bearer"
?  ?? Name: "john_doe"
?
?? Claims (IEnumerable<Claim>)
   ?? Claim
   ?  ?? Type: "http://schemas.xmlsoap.org/.../nameidentifier"
   ?  ?? Value: "3fa85f64-5717-4562-b3fc-2c963f66afa6"
   ?
   ?? Claim
   ?  ?? Type: "http://schemas.xmlsoap.org/.../name"
   ?  ?? Value: "john_doe"
   ?
   ?? Claim
   ?  ?? Type: "http://schemas.xmlsoap.org/.../emailaddress"
   ?  ?? Value: "john@example.com"
   ?
   ?? Claim (Role 1)
   ?  ?? Type: "http://schemas.microsoft.com/.../role"
   ?  ?? Value: "User"
   ?
   ?? Claim (Role 2)
   ?  ?? Type: "http://schemas.microsoft.com/.../role"
   ?  ?? Value: "Admin"
   ?
   ?? Claim (Authority 1)
   ?  ?? Type: "authority"
   ?  ?? Value: "POST"
   ?
   ?? Claim (Authority 2)
      ?? Type: "authority"
      ?? Value: "DELETE"
```

## ? AsyncLocal<T> - How HttpContextAccessor Works

```csharp
// Simplified implementation of HttpContextAccessor
public class HttpContextAccessor : IHttpContextAccessor
{
    // AsyncLocal provides ambient context across async calls
    private static readonly AsyncLocal<HttpContext?> _httpContext = new();
    
    public HttpContext? HttpContext
    {
        get => _httpContext.Value;
        set => _httpContext.Value = value;
    }
}

// AsyncLocal ensures:
// - Each async context gets its own value
// - Value flows through async/await
// - Thread-safe for concurrent requests
```

## ?? Thread Safety Visualization

```
Request 1                    Request 2                    Request 3
Thread A                     Thread B                     Thread C
?                            ?                            ?
?? HttpContext A ????       ?? HttpContext B ????       ?? HttpContext C ????
?                   ?        ?                   ?        ?                   ?
?  AsyncLocal       ?        ?  AsyncLocal       ?        ?  AsyncLocal       ?
?  stores context   ?        ?  stores context   ?        ?  stores context   ?
?  for Request 1    ?        ?  for Request 2    ?        ?  for Request 3    ?
?                   ?        ?                   ?        ?                   ?
?? await Something()?        ?? await Something()?        ?? await Something()?
?  ?                ?        ?  ?                ?        ?  ?                ?
?  Context flows    ?        ?  Context flows    ?        ?  Context flows    ?
?  through await    ?        ?  through await    ?        ?  through await    ?
?  ?                ?        ?  ?                ?        ?  ?                ?
?? Still Context A ??        ?? Still Context B ??        ?? Still Context C ??
?                            ?                            ?
?                            ?                            ?
Complete                     Complete                     Complete
```

## ?? Summary

1. **IHttpContextAccessor**: Interface cho phép access HttpContext t? services
2. **HttpContextAccessor**: Implementation s? d?ng AsyncLocal<T> ?? l?u context per request
3. **HttpContext**: Ch?a t?t c? thông tin v? HTTP request/response hi?n t?i
4. **HttpContext.User**: ClaimsPrincipal ch?a claims t? JWT token
5. **Singleton**: HttpContextAccessor là singleton nh?ng HttpContext là per-request
6. **Thread-safe**: AsyncLocal ??m b?o m?i request có context riêng
