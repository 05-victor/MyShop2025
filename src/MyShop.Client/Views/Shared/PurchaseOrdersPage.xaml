<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Client.Views.Shared.PurchaseOrdersPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:components="using:MyShop.Client.Views.Components"
    xmlns:forms="using:MyShop.Client.Views.Components.Forms"
    xmlns:pagination="using:MyShop.Client.Views.Components.Pagination"
    xmlns:layout="using:MyShop.Client.Views.Components.Layout"
    xmlns:buttons="using:MyShop.Client.Views.Components.Buttons"
    xmlns:converters="using:MyShop.Client.Common.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:MyShop.Client.ViewModels.Shared"
    mc:Ignorable="d"
    Background="#F8FAFC">

    <Page.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:CurrencyFormatConverter x:Key="CurrencyFormatConverter"/>
        <converters:CurrencyConverter x:Key="CurrencyConverter"/>
        <Style x:Key="CardStyle"
                TargetType="Border">
            <Setter Property="Background"
                    Value="White"/>
            <Setter Property="CornerRadius"
                    Value="12"/>
            <Setter Property="BorderBrush"
                    Value="#E5E7EB"/>
            <Setter Property="BorderThickness"
                    Value="1"/>
            <Setter Property="Padding"
                    Value="24"/>
        </Style>

        <Style x:Key="StatCardStyle"
                TargetType="Border">
            <Setter Property="Background"
                    Value="White"/>
            <Setter Property="CornerRadius"
                    Value="12"/>
            <Setter Property="BorderBrush"
                    Value="#E5E7EB"/>
            <Setter Property="BorderThickness"
                    Value="1"/>
            <Setter Property="Padding"
                    Value="16"/>
        </Style>

        <Style x:Key="FilterToggleButtonStyle"
                TargetType="ToggleButton">
            <Setter Property="Background"
                    Value="White"/>
            <Setter Property="Foreground"
                    Value="#6B7280"/>
            <Setter Property="BorderBrush"
                    Value="#E5E7EB"/>
            <Setter Property="BorderThickness"
                    Value="1"/>
            <Setter Property="Padding"
                    Value="12,8"/>
            <Setter Property="CornerRadius"
                    Value="8"/>
            <Setter Property="MinWidth"
                    Value="60"/>
        </Style>
    </Page.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <ScrollViewer Grid.Row="1"
                VerticalScrollBarVisibility="Auto">
            <StackPanel Padding="32"
                    Spacing="24">

                <!-- Page Header -->
                <layout:PageHeader
                    Title="My Orders"
                    Subtitle="Track and manage your orders"/>

                <!-- Order Stats -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Total Orders -->
                    <Border Grid.Column="0"
                            Style="{StaticResource StatCardStyle}"
                            Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal"
                                Spacing="12">
                            <Border Width="40"
                                    Height="40"
                                    Background="#EEF2FF"
                                    CornerRadius="8">
                                <FontIcon Glyph="&#xF133;"
                                        FontSize="20"
                                        Foreground="#2563EB"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel>
                                <TextBlock Text="Total Orders"
                                        FontSize="12"
                                        Foreground="#6B7280"/>
                                <TextBlock Text="{x:Bind ViewModel.TotalOrders, Mode=OneWay}"
                                        FontSize="18"
                                        FontWeight="SemiBold"
                                        Foreground="#111827"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Pending -->
                    <Border Grid.Column="1"
                            Style="{StaticResource StatCardStyle}"
                            Margin="4,0">
                        <StackPanel Orientation="Horizontal"
                                Spacing="12">
                            <Border Width="40"
                                    Height="40"
                                    Background="#F3F4F6"
                                    CornerRadius="8">
                                <FontIcon Glyph="&#xE121;"
                                        FontSize="20"
                                        Foreground="#6B7280"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel>
                                <TextBlock Text="Pending"
                                        FontSize="12"
                                        Foreground="#6B7280"/>
                                <TextBlock Text="{x:Bind ViewModel.PendingOrders, Mode=OneWay}"
                                        FontSize="18"
                                        FontWeight="SemiBold"
                                        Foreground="#111827"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- In Transit -->
                    <Border Grid.Column="2"
                            Style="{StaticResource StatCardStyle}"
                            Margin="4,0">
                        <StackPanel Orientation="Horizontal"
                                Spacing="12">
                            <Border Width="40"
                                    Height="40"
                                    Background="#DBEAFE"
                                    CornerRadius="8">
                                <FontIcon Glyph="&#xE916;"
                                        FontSize="20"
                                        Foreground="#00AEEF"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel>
                                <TextBlock Text="In Transit"
                                        FontSize="12"
                                        Foreground="#6B7280"/>
                                <TextBlock Text="{x:Bind ViewModel.InTransitOrders, Mode=OneWay}"
                                        FontSize="18"
                                        FontWeight="SemiBold"
                                        Foreground="#111827"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Delivered -->
                    <Border Grid.Column="3"
                            Style="{StaticResource StatCardStyle}"
                            Margin="4,0">
                        <StackPanel Orientation="Horizontal"
                                Spacing="12">
                            <Border Width="40"
                                    Height="40"
                                    Background="#D1FAE5"
                                    CornerRadius="8">
                                <FontIcon Glyph="&#xE73E;"
                                        FontSize="20"
                                        Foreground="#10B981"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel>
                                <TextBlock Text="Delivered"
                                        FontSize="12"
                                        Foreground="#6B7280"/>
                                <TextBlock Text="{x:Bind ViewModel.DeliveredOrders, Mode=OneWay}"
                                        FontSize="18"
                                        FontWeight="SemiBold"
                                        Foreground="#111827"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Total Spent -->
                    <Border Grid.Column="4"
                            Style="{StaticResource StatCardStyle}"
                            Margin="8,0,0,0">
                        <StackPanel Orientation="Horizontal"
                                Spacing="12">
                            <Border Width="40"
                                    Height="40"
                                    Background="#FEF3C7"
                                    CornerRadius="8">
                                <FontIcon Glyph="&#xE8C7;"
                                        FontSize="20"
                                        Foreground="#F59E0B"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                            </Border>
                            <StackPanel>
                                <TextBlock Text="Total Spent"
                                        FontSize="12"
                                        Foreground="#6B7280"/>
                                <TextBlock Text="{x:Bind ViewModel.TotalSpent, Converter={StaticResource CurrencyConverter}, Mode=OneWay}"
                                        FontSize="18"
                                        FontWeight="SemiBold"
                                        Foreground="#111827"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Filters -->
                <Border Style="{StaticResource CardStyle}">
                    <StackPanel Spacing="16">
                        <!-- Search Box (auto complete - no button needed) -->
                        <AutoSuggestBox x:Name="SearchBox"
                                        PlaceholderText="Search by order ID, tracking, or product name..."
                                        QueryIcon="Find"
                                        Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        TextChanged="SearchBox_TextChanged"
                                        QuerySubmitted="SearchBox_QuerySubmitted"
                                        Height="40"
                                        CornerRadius="8"/>

                        <!-- Filter Buttons and Sort -->
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Orientation="Horizontal"
                                    Spacing="8">
                                <ToggleButton x:Name="FilterAll"
                                        Content="All"
                                              Style="{StaticResource FilterToggleButtonStyle}"
                                              IsChecked="True"
                                              Click="FilterButton_Click"
                                        Tag="All"/>
                                <ToggleButton x:Name="FilterPending"
                                        Content="Pending"
                                              Style="{StaticResource FilterToggleButtonStyle}"
                                              Click="FilterButton_Click"
                                        Tag="Pending"/>
                                <ToggleButton x:Name="FilterPaid"
                                        Content="Paid"
                                              Style="{StaticResource FilterToggleButtonStyle}"
                                              Click="FilterButton_Click"
                                        Tag="PAID"/>
                                <ToggleButton x:Name="FilterShipped"
                                        Content="Shipped"
                                              Style="{StaticResource FilterToggleButtonStyle}"
                                              Click="FilterButton_Click"
                                        Tag="Shipped"/>
                                <ToggleButton x:Name="FilterDelivered"
                                        Content="Delivered"
                                              Style="{StaticResource FilterToggleButtonStyle}"
                                              Click="FilterButton_Click"
                                        Tag="DELIVERED"/>
                            </StackPanel>

                            <ComboBox Grid.Column="1"
                                    x:Name="SortComboBox"
                                    Width="200"
                                    PlaceholderText="Sort by"
                                      BorderBrush="#E5E7EB"
                                    SelectionChanged="SortComboBox_SelectionChanged">
                                <ComboBoxItem Content="Newest First"
                                        IsSelected="True"/>
                                <ComboBoxItem Content="Oldest First"/>
                                <ComboBoxItem Content="Highest Amount"/>
                                <ComboBoxItem Content="Lowest Amount"/>
                            </ComboBox>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Order Cards List -->
                <ItemsRepeater x:Name="OrdersRepeater"
                        ItemsSource="{x:Bind ViewModel.Items, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <StackLayout Spacing="16"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:OrderViewModel">
                            <Border Style="{StaticResource CardStyle}">
                                <Grid ColumnDefinitions="Auto,*,300">
                                    <!-- Left: Product Image -->
                                    <Border Width="80"
                                            Height="80"
                                            CornerRadius="8"
                                            Background="#F3F4F6"
                                            Margin="0,0,16,0">
                                        <Image Stretch="UniformToFill">
                                            <Image.Source>
                                                <BitmapImage UriSource="{x:Bind FirstProductImage}"
                                                        DecodePixelWidth="80"/>
                                            </Image.Source>
                                        </Image>
                                    </Border>

                                    <!-- Middle: Order Info -->
                                    <StackPanel Grid.Column="1"
                                            Spacing="12">
                                        <Grid>
                                            <StackPanel>
                                                <TextBlock Text="{x:Bind ProductSummary}"
                                                        FontSize="18"
                                                        FontWeight="SemiBold"
                                                        Foreground="#111827"
                                                        TextTrimming="CharacterEllipsis"
                                                        MaxWidth="400"/>
                                                <TextBlock Text="{x:Bind OrderId}"
                                                        FontSize="13"
                                                        Foreground="#6B7280"
                                                        Margin="0,4,0,0"/>
                                                <StackPanel Orientation="Horizontal"
                                                        Spacing="12"
                                                        Margin="0,4,0,0">
                                                    <StackPanel Orientation="Horizontal"
                                                            Spacing="4">
                                                        <FontIcon Glyph="&#xE787;"
                                                                FontSize="14"
                                                                Foreground="#6B7280"/>
                                                        <TextBlock Text="{x:Bind FormattedOrderDate}"
                                                                FontSize="12"
                                                                Foreground="#6B7280"/>
                                                    </StackPanel>
                                                    <TextBlock FontSize="12"
                                                            Foreground="#6B7280">
                                                        <Run Text="Tracking: "/>
                                                        <Run Text="{x:Bind TrackingNumber}"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </StackPanel>
                                            <Border Padding="8,4"
                                                    CornerRadius="6"
                                                    HorizontalAlignment="Right"
                                                    VerticalAlignment="Top">
                                                <Border.Background>
                                                    <SolidColorBrush Color="{x:Bind StatusBgColor}"/>
                                                </Border.Background>
                                                <StackPanel Orientation="Horizontal"
                                                        Spacing="4">
                                                    <FontIcon Glyph="&#xE73E;"
                                                            FontSize="14">
                                                        <FontIcon.Foreground>
                                                            <SolidColorBrush Color="{x:Bind StatusColor}"/>
                                                        </FontIcon.Foreground>
                                                    </FontIcon>
                                                    <TextBlock Text="{x:Bind Status}"
                                                            FontSize="12"
                                                            FontWeight="SemiBold">
                                                        <TextBlock.Foreground>
                                                            <SolidColorBrush Color="{x:Bind StatusColor}"/>
                                                        </TextBlock.Foreground>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Border>
                                        </Grid>

                                        <!-- Status Alert -->
                                        <Border Background="#D1FAE5"
                                                Padding="12"
                                                CornerRadius="8"
                                                Visibility="{x:Bind DeliveredDate, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal"
                                                    Spacing="8">
                                                <FontIcon Glyph="&#xE73E;"
                                                        FontSize="16"
                                                        Foreground="#10B981"/>
                                                <TextBlock Text="{x:Bind DeliveryMessage}"
                                                        FontSize="14"
                                                        Foreground="#10B981"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>

                                    <!-- Right: Order Summary & Actions -->
                                    <StackPanel Grid.Column="2"
                                            Margin="24,0,0,0"
                                            Spacing="16">
                                        <Border Background="#F9FAFB"
                                                Padding="16"
                                                CornerRadius="8">
                                            <StackPanel Spacing="12">
                                                <Grid>
                                                    <TextBlock Text="Subtotal"
                                                            FontSize="14"
                                                            Foreground="#6B7280"/>
                                                    <TextBlock Text="{x:Bind Subtotal, Converter={StaticResource CurrencyConverter}}"
                                                            FontSize="14"
                                                            Foreground="#111827"
                                                            HorizontalAlignment="Right"/>
                                                </Grid>
                                                <Grid>
                                                    <TextBlock Text="Shipping"
                                                            FontSize="14"
                                                            Foreground="#6B7280"/>
                                                    <TextBlock Text="{x:Bind Shipping, Converter={StaticResource CurrencyConverter}}"
                                                            FontSize="14"
                                                            Foreground="#111827"
                                                            HorizontalAlignment="Right"/>
                                                </Grid>
                                                <Grid>
                                                    <TextBlock Text="Tax"
                                                            FontSize="14"
                                                            Foreground="#6B7280"/>
                                                    <TextBlock Text="{x:Bind Tax, Converter={StaticResource CurrencyConverter}}"
                                                            FontSize="14"
                                                            Foreground="#111827"
                                                            HorizontalAlignment="Right"/>
                                                </Grid>
                                                <Border Height="1"
                                                        Background="#E5E7EB"/>
                                                <Grid>
                                                    <TextBlock Text="Total"
                                                            FontSize="14"
                                                            FontWeight="SemiBold"
                                                            Foreground="#111827"/>
                                                    <TextBlock Text="{x:Bind Total, Converter={StaticResource CurrencyConverter}}"
                                                            FontSize="18"
                                                            FontWeight="Bold"
                                                            Foreground="#111827"
                                                            HorizontalAlignment="Right"/>
                                                </Grid>
                                            </StackPanel>
                                        </Border>

                                        <StackPanel Spacing="8">
                                            <Button Content="View Details &amp; Tracking"
                                                    Background="#2563EB"
                                                    Foreground="White"
                                                    Padding="16"
                                                    CornerRadius="8"
                                                    HorizontalAlignment="Stretch"
                                                    Command="{Binding ElementName=OrdersRepeater, Path=Tag.ViewOrderDetailsCommand}"
                                                    CommandParameter="{x:Bind}"/>
                                            <Button Content="ðŸ›’ Buy Again"
                                                    Background="Transparent"
                                                    BorderBrush="#2563EB"
                                                    Foreground="#2563EB"
                                                    Padding="16"
                                                    CornerRadius="8"
                                                    HorizontalAlignment="Stretch"
                                                    Command="{Binding ElementName=OrdersRepeater, Path=Tag.BuyAgainCommand}"
                                                    CommandParameter="{x:Bind}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>

                <!-- Empty State -->
                <Border Style="{StaticResource CardStyle}"
                        Visibility="{x:Bind ViewModel.HasNoItems, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Spacing="12"
                            Padding="48">
                        <FontIcon Glyph="&#xE719;"
                                FontSize="48"
                                Foreground="#9CA3AF"/>
                        <TextBlock Text="No orders found"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Foreground="#6B7280"
                                HorizontalAlignment="Center"/>
                        <TextBlock Text="Try adjusting your search or filters"
                                FontSize="14"
                                Foreground="#9CA3AF"
                                HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>

        <!-- Pagination Control -->
        <pagination:PaginationControl Grid.Row="2"
                                      CurrentPage="{x:Bind ViewModel.CurrentPage, Mode=TwoWay}"
                                      TotalItems="{x:Bind ViewModel.TotalItems, Mode=OneWay}"
                                      PageSize="{x:Bind ViewModel.PageSize, Mode=OneWay}"
                                      PageChanged="OnPageChanged"
                                      Margin="32,16"/>
    </Grid>
</Page>
