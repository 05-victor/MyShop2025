<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="MyShop.Client.Views.Shared.CategoriesPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:buttons="using:MyShop.Client.Views.Components.Buttons"
    xmlns:converters="using:MyShop.Client.Common.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:skeletons="using:MyShop.Client.Views.Components.Skeletons"
    xmlns:responses="using:MyShop.Shared.DTOs.Responses"
    xmlns:layout="using:MyShop.Client.Views.Components.Layout"
    xmlns:emptyStates="using:MyShop.Client.Views.Components.EmptyStates"
    Background="{ThemeResource PageBackgroundBrush}"
    mc:Ignorable="d">

    <Page.Transitions>
        <TransitionCollection>
            <EntranceThemeTransition FromVerticalOffset="50"/>
        </TransitionCollection>
    </Page.Transitions>

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibility"/>
        <converters:CountToVisibilityConverter x:Key="InvertCountToVisibility" IsInverted="True"/>
    </Page.Resources>

    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="ResponsiveStates">
                <VisualState x:Name="LargeDesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1920"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="40"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="DesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1280"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="32"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="TabletState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="960"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="24"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="TabletPortraitState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="20"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="MobileState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="16"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <RefreshContainer RefreshRequested="RefreshContainer_RefreshRequested">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid x:Name="MainContent" Padding="24" RowSpacing="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header -->
                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <layout:PageHeader 
                            Grid.Column="0"
                            Title="Categories"
                            Subtitle="Manage product categories"/>

                        <!-- Actions -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <buttons:IconButton 
                                IconGlyph="&#xE72C;"
                                Text="Refresh"
                                Tooltip="Refresh categories"
                                Command="{x:Bind ViewModel.RefreshCommand}"/>
                            <Button Style="{StaticResource AccentButtonStyle}"
                                    Click="AddCategoryButton_Click">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <FontIcon Glyph="&#xE710;" FontSize="16"/>
                                    <TextBlock Text="Add Category"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>

                    <!-- Main Content -->
                    <StackPanel Grid.Row="1" Spacing="16">

                        <!-- Loading Skeleton -->
                        <skeletons:SkeletonTable 
                            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- Content (when not loading) -->
                        <StackPanel 
                            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                            Spacing="16">

                            <!-- Search & Filter Card -->
                            <Border Style="{StaticResource CardWithShadowStyle}">
                                <StackPanel Spacing="12">
                                    <Grid ColumnSpacing="12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Search Box -->
                                        <TextBox 
                                            Grid.Column="0"
                                            PlaceholderText="Search by name or description..."
                                            Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <TextBox.KeyboardAccelerators>
                                                <KeyboardAccelerator Key="Escape" Invoked="SearchBox_EscapePressed"/>
                                            </TextBox.KeyboardAccelerators>
                                        </TextBox>

                                        <!-- Clear Button -->
                                        <Button 
                                            Grid.Column="1"
                                            Content="Clear"
                                            Command="{x:Bind ViewModel.ClearSearchCommand}"
                                            Style="{StaticResource DefaultButtonStyle}"/>
                                    </Grid>

                                    <!-- Sort -->
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock 
                                            Text="Sort:"
                                            VerticalAlignment="Center"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <ComboBox 
                                            SelectedItem="{x:Bind ViewModel.SelectedSortOption, Mode=TwoWay}"
                                            MinWidth="150">
                                            <x:String>Name A-Z</x:String>
                                            <x:String>Name Z-A</x:String>
                                        </ComboBox>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- Empty State (No Categories) -->
                            <emptyStates:EmptyStateControl
                                Visibility="{x:Bind ViewModel.Categories.Count, Mode=OneWay, Converter={StaticResource InvertCountToVisibility}}"
                                Title="No categories yet"
                                Description="Create your first category to organize your products"
                                IconGlyph="&#xE8D2;"
                                ActionText="Add Category"
                                ActionCommand="{x:Bind AddCategoryCommand}"/>

                            <!-- Empty State (No Search Results) -->
                            <emptyStates:EmptyStateControl
                                Visibility="{x:Bind ShowNoResultsState(ViewModel.Categories.Count, ViewModel.FilteredCategories.Count, ViewModel.SearchText), Mode=OneWay}"
                                Title="No results"
                                Description="No categories match your search"
                                IconGlyph="&#xE721;"
                                ActionText="Clear search"
                                ActionCommand="{x:Bind ViewModel.ClearSearchCommand}"/>

                            <!-- Categories Table -->
                            <Border 
                                Visibility="{x:Bind ViewModel.FilteredCategories.Count, Mode=OneWay, Converter={StaticResource CountToVisibility}}"
                                Style="{StaticResource CardWithShadowStyle}"
                                Padding="0">
                            <ListView 
                                ItemsSource="{x:Bind ViewModel.FilteredCategories, Mode=OneWay}"
                                SelectionMode="None">
                                <ListView.Header>
                                    <Grid 
                                        Padding="24,16"
                                        Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                        BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                        BorderThickness="0,0,0,1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="2*"/>
                                            <ColumnDefinition Width="3*"/>
                                            <ColumnDefinition Width="120"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock 
                                            Grid.Column="0"
                                            Text="CATEGORY"
                                            FontWeight="SemiBold"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock 
                                            Grid.Column="1"
                                            Text="DESCRIPTION"
                                            FontWeight="SemiBold"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock 
                                            Grid.Column="2"
                                            Text="ACTIONS"
                                            FontWeight="SemiBold"
                                            HorizontalAlignment="Right"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                    </Grid>
                                </ListView.Header>
                                <ListView.ItemTemplate>
                                    <DataTemplate x:DataType="responses:CategoryResponse">
                                        <Grid 
                                            Padding="24,16"
                                            BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                                            BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="2*"/>
                                                <ColumnDefinition Width="3*"/>
                                                <ColumnDefinition Width="120"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Category Name + ID -->
                                            <StackPanel Grid.Column="0" Spacing="4">
                                                <TextBlock 
                                                    Text="{x:Bind Name}"
                                                    FontWeight="SemiBold"
                                                    TextTrimming="CharacterEllipsis"/>
                                                <TextBlock 
                                                    Text="{x:Bind Id}"
                                                    FontSize="11"
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                    TextTrimming="CharacterEllipsis"/>
                                            </StackPanel>

                                            <!-- Description -->
                                            <TextBlock 
                                                Grid.Column="1"
                                                Text="{x:Bind Description}"
                                                MaxLines="2"
                                                TextWrapping="Wrap"
                                                TextTrimming="CharacterEllipsis"
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                                            <!-- Actions -->
                                            <StackPanel 
                                                Grid.Column="2"
                                                Orientation="Horizontal"
                                                Spacing="8"
                                                HorizontalAlignment="Right">
                                                <Button 
                                                    Click="EditButton_Click"
                                                    Tag="{x:Bind}"
                                                    ToolTipService.ToolTip="Edit"
                                                    Style="{StaticResource IconButtonStyle}">
                                                    <FontIcon Glyph="&#xE70F;" FontSize="16"/>
                                                </Button>
                                                <Button 
                                                    Click="DeleteButton_Click"
                                                    Tag="{x:Bind}"
                                                    ToolTipService.ToolTip="Delete"
                                                    Style="{StaticResource DangerIconButtonStyle}">
                                                    <FontIcon Glyph="&#xE74D;" FontSize="16"/>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Border>

                        </StackPanel>

                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </RefreshContainer>
    </Grid>
</Page>
