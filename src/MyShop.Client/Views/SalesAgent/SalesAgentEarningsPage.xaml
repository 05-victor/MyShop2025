<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Client.Views.SalesAgent.EarningsPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:components="using:MyShop.Client.Views.Components"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:cards="using:MyShop.Client.Views.Components.Cards"
    xmlns:layout="using:MyShop.Client.Views.Components.Layout"
    xmlns:buttons="using:MyShop.Client.Views.Components.Buttons"
    xmlns:forms="using:MyShop.Client.Views.Components.Forms"
    xmlns:pagination="using:MyShop.Client.Views.Components.Pagination"
    xmlns:converters="using:MyShop.Client.Common.Converters"
    xmlns:viewmodels="using:MyShop.Client.ViewModels.SalesAgent"
    mc:Ignorable="d"
    Background="{ThemeResource SubtleFillColorSecondaryBrush}">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:CurrencyConverter x:Key="CurrencyConverter"/>
        <converters:StringToBrushConverter x:Key="StringToBrushConverter"/>
    </Page.Resources>

    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="ResponsiveStates">

                <!-- Large Desktop: 1920px+ -->
                <VisualState x:Name="LargeDesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1920"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="40"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="24"/>
                        <Setter Target="KPIGrid.RowSpacing"
                                Value="24"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Desktop: 1280-1919px -->
                <VisualState x:Name="DesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1280"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="32"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="20"/>
                        <Setter Target="KPIGrid.RowSpacing"
                                Value="20"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet: 960-1279px -->
                <VisualState x:Name="TabletState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="960"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="24"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="16"/>
                        <Setter Target="KPIGrid.RowSpacing"
                                Value="16"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet Portrait: 640-959px -->
                <VisualState x:Name="TabletPortraitState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="20"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="12"/>
                        <Setter Target="KPIGrid.RowSpacing"
                                Value="12"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Mobile: 0-639px (Default) -->
                <VisualState x:Name="MobileState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="16"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="8"/>
                        <Setter Target="KPIGrid.RowSpacing"
                                Value="8"/>
                    </VisualState.Setters>
                </VisualState>

            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <!-- Layer 0: Main Content (Hidden during loading) -->
        <Grid x:Name="MainContent"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <Grid.Transitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="50"/>
                </TransitionCollection>
            </Grid.Transitions>
            <RefreshContainer RefreshRequested="RefreshContainer_RefreshRequested">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel x:Name="ContentStackPanel"
                            Padding="32"
                            Spacing="24">

                        <!-- PAGE HEADER -->
                        <layout:PageHeader
                            Title="My Earnings"
                            Subtitle="Track your income and platform fees">
                            <layout:PageHeader.ActionContent>
                                <StackPanel Orientation="Horizontal"
                                        Spacing="12">
                                    <ComboBox x:Name="PeriodComboBox"
                                              Width="180"
                                              SelectedIndex="0"
                                              VerticalAlignment="Center"
                                              CornerRadius="8"
                                              SelectionChanged="PeriodComboBox_SelectionChanged">
                                        <ComboBoxItem Content="All Time"
                                                Tag="all"/>
                                        <ComboBoxItem Content="This Month"
                                                Tag="month"/>
                                        <ComboBoxItem Content="Last Month"
                                                Tag="last-month"/>
                                        <ComboBoxItem Content="Last 3 Months"
                                                Tag="3months"/>
                                    </ComboBox>
                                    <buttons:IconButton
                                        Variant="Outline"
                                        IconGlyph="&#xE72C;"
                                        Text="Refresh"
                                        Command="{x:Bind ViewModel.RefreshCommand}"
                                        ToolTipService.ToolTip="Reload earnings data"/>
                                    <buttons:IconButton
                                        Variant="Outline"
                                        IconGlyph="&#xE74E;"
                                        Text="Export CSV"
                                        Command="{x:Bind ViewModel.ExportCommissionsCommand}"
                                        ToolTipService.ToolTip="Export earnings to CSV"/>
                                    <buttons:IconButton
                                        Variant="Filled"
                                        IconGlyph="&#xEA90;"
                                        Text="Export PDF"
                                        Click="ExportPdfButton_Click"
                                        ToolTipService.ToolTip="Export commission report as PDF"/>
                                </StackPanel>
                            </layout:PageHeader.ActionContent>
                        </layout:PageHeader>

                        <!-- Platform Fee Info Banner -->
                        <InfoBar Severity="Informational"
                                 Title="Platform Fee Rate"
                                 Message="Platform fee is 10% of order total. Your net earnings = Order Total - (10% platform fee)"
                                 IsOpen="True"
                                 IsClosable="False">
                            <InfoBar.IconSource>
                                <FontIconSource Glyph="&#xE946;"/>
                            </InfoBar.IconSource>
                        </InfoBar>

                        <!-- KPI Cards -->
                        <Grid x:Name="KPIGrid">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnSpacing>20</Grid.ColumnSpacing>
                            <Grid.RowSpacing>20</Grid.RowSpacing>

                            <!-- Row 0 -->
                            <!-- Total Earnings -->
                            <cards:KPICard
                                Grid.Row="0"
                                Grid.Column="0"
                                Title="Total Earnings"
                                Icon="&#xE7DB;"
                                Value="{x:Bind ViewModel.TotalEarnings, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="Gross revenue"
                                ShowBadge="Visible"
                                TrendIcon="&#xE74E;"
                                TrendText="+12.5%"
                                IconBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                IconForegroundBrush="{ThemeResource SuccessGreenBrush}"
                                BadgeBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                BadgeForegroundBrush="{ThemeResource SuccessGreenBrush}"/>

                            <!-- Platform Fees -->
                            <cards:KPICard
                                Grid.Row="0"
                                Grid.Column="1"
                                Title="Platform Fees"
                                Icon="&#xE946;"
                                Value="{x:Bind ViewModel.TotalPlatformFees, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="10% commission"
                                ShowBadge="Collapsed"
                                IconBackgroundBrush="{ThemeResource ErrorRedLightBrush}"
                                IconForegroundBrush="{ThemeResource ErrorRedBrush}"/>

                            <!-- Net Earnings -->
                            <cards:KPICard
                                Grid.Row="0"
                                Grid.Column="2"
                                Title="Net Earnings"
                                Icon="&#xE8EC;"
                                Value="{x:Bind ViewModel.NetEarnings, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="After fees"
                                ShowBadge="Visible"
                                TrendIcon="&#xE74E;"
                                TrendText="+8.2%"
                                IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                IconForegroundBrush="{ThemeResource PrimaryBrush}"
                                BadgeBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                BadgeForegroundBrush="{ThemeResource PrimaryBrush}"/>

                            <!-- Row 1 -->
                            <!-- Paid Earnings -->
                            <cards:KPICard
                                Grid.Row="1"
                                Grid.Column="0"
                                Title="Paid Out"
                                Icon="&#xE8AB;"
                                Value="{x:Bind ViewModel.PaidEarnings, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="Settled payments"
                                ShowBadge="Collapsed"
                                IconBackgroundBrush="{ThemeResource PurpleLightBrush}"
                                IconForegroundBrush="{ThemeResource PurpleBrush}"/>

                            <!-- Pending Earnings -->
                            <cards:KPICard
                                Grid.Row="1"
                                Grid.Column="1"
                                Title="Pending Earnings"
                                Icon="&#xE716;"
                                Value="{x:Bind ViewModel.PendingEarnings, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="Awaiting payment"
                                ShowBadge="Collapsed"
                                IconBackgroundBrush="{ThemeResource WarningAmberLightBrush}"
                                IconForegroundBrush="{ThemeResource WarningAmberBrush}"/>

                            <!-- Total Orders -->
                            <cards:KPICard
                                Grid.Row="1"
                                Grid.Column="2"
                                Title="Total Orders"
                                Icon="&#xE7BF;"
                                Value="{x:Bind ViewModel.TotalOrders, Mode=OneWay}"
                                Subtitle="Orders completed"
                                ShowBadge="Collapsed"
                                IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                IconForegroundBrush="{ThemeResource PrimaryBrush}"/>

                            <!-- Row 2 -->
                            <!-- Average Earnings Per Order -->
                            <cards:KPICard
                                Grid.Row="2"
                                Grid.Column="0"
                                Title="Avg per Order"
                                Icon="&#xE7DB;"
                                Value="{x:Bind ViewModel.AverageEarningsPerOrder, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="Average earnings"
                                ShowBadge="Collapsed"
                                IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                IconForegroundBrush="{ThemeResource PrimaryBrush}"/>

                            <!-- This Month Earnings -->
                            <cards:KPICard
                                Grid.Row="2"
                                Grid.Column="1"
                                Title="This Month"
                                Icon="&#xE74E;"
                                Value="{x:Bind ViewModel.ThisMonthEarnings, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="Current month"
                                ShowBadge="Visible"
                                TrendIcon="&#xE74E;"
                                TrendText="+6.8%"
                                IconBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                IconForegroundBrush="{ThemeResource SuccessGreenBrush}"
                                BadgeBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                BadgeForegroundBrush="{ThemeResource SuccessGreenBrush}"/>

                            <!-- Last Month Earnings -->
                            <cards:KPICard
                                Grid.Row="2"
                                Grid.Column="2"
                                Title="Last Month"
                                Icon="&#xE74E;"
                                Value="{x:Bind ViewModel.LastMonthEarnings, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                Subtitle="Previous month"
                                ShowBadge="Collapsed"
                                IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                IconForegroundBrush="{ThemeResource PrimaryBrush}"/>
                        </Grid>

                        <!-- SEARCH CARD with Auto-Complete -->
                        <forms:SearchCard
                            x:Name="EarningsSearchCard"
                            PlaceholderText="Search by order, product, or customer..."
                            SearchText="{x:Bind ViewModel.SearchQuery, Mode=TwoWay}"
                            ShowSearchButton="Collapsed"
                            TextChanged="SearchCard_TextChanged"
                            SuggestionChosen="SearchCard_SuggestionChosen"
                            QuerySubmitted="SearchCard_QuerySubmitted"/>

                        <!-- FILTER CARD with Apply Button -->
                        <forms:FilterCard Title="Filters"
                                          ApplyCommand="{x:Bind ViewModel.ApplyFiltersCommand}"
                                          ResetCommand="{x:Bind ViewModel.ResetFiltersCommand}"
                                          ShowActions="True"
                                          ShowResetButton="True">
                            <forms:FilterCard.FilterContent>
                                <StackPanel>
                                    <TextBlock Text="Status"
                                            FontSize="12"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            Margin="0,0,0,4"/>
                                    <ComboBox x:Name="StatusComboBox"
                                              HorizontalAlignment="Stretch"
                                              SelectedIndex="0"
                                              CornerRadius="8"
                                              SelectionChanged="StatusComboBox_SelectionChanged">
                                        <ComboBoxItem Content="All Status"
                                                Tag="All"/>
                                        <ComboBoxItem Content="Paid"
                                                Tag="Paid"/>
                                        <ComboBoxItem Content="Approved"
                                                Tag="Approved"/>
                                        <ComboBoxItem Content="Pending"
                                                Tag="Pending"/>
                                    </ComboBox>
                                </StackPanel>
                            </forms:FilterCard.FilterContent>
                        </forms:FilterCard>

                        <!-- Transactions Table -->
                        <cards:DataTableCard Title="Earning Transactions">
                            <cards:DataTableCard.TableContent>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Table Header -->
                                    <Grid Grid.Row="0"
                                          Padding="0,12"
                                          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                          BorderThickness="0,0,0,1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="100"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0"
                                                Text="ORDER ID"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Column="1"
                                                Text="PRODUCT"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Column="2"
                                                Text="CUSTOMER"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Column="3"
                                                Text="TOTAL"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Column="4"
                                                Text="FEE (10%)"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Column="5"
                                                Text="NET"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        <TextBlock Grid.Column="6"
                                                Text="STATUS"
                                                   FontSize="11"
                                                FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                    </Grid>

                                    <!-- Table Body -->
                                    <ScrollViewer Grid.Row="1"
                                            MaxHeight="400">
                                        <ItemsRepeater ItemsSource="{x:Bind ViewModel.Commissions, Mode=OneWay}">
                                            <ItemsRepeater.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:CommissionViewModel">
                                                    <Grid Padding="0,12"
                                                          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                          BorderThickness="0,0,0,1">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="100"/>
                                                            <ColumnDefinition Width="100"/>
                                                        </Grid.ColumnDefinitions>

                                                        <TextBlock Grid.Column="0"
                                                                   Text="{x:Bind OrderId, Mode=OneWay}"
                                                                   FontSize="13"
                                                                   FontFamily="Consolas"
                                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                                                        <TextBlock Grid.Column="1"
                                                                   Text="{x:Bind ProductName, Mode=OneWay}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"/>

                                                        <TextBlock Grid.Column="2"
                                                                   Text="{x:Bind CustomerName, Mode=OneWay}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                                                        <TextBlock Grid.Column="3"
                                                                   Text="{x:Bind SaleAmount, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>

                                                        <TextBlock Grid.Column="4"
                                                                   Text="{x:Bind CommissionAmount, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource ErrorRedBrush}"/>

                                                        <TextBlock Grid.Column="5"
                                                                   Text="{x:Bind NetIncome, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="14"
                                                                   FontWeight="Bold"
                                                                   Foreground="{ThemeResource SuccessGreenBrush}"/>

                                                        <Border Grid.Column="6"
                                                                Background="{x:Bind StatusBgColor, Mode=OneWay, Converter={StaticResource StringToBrushConverter}}"
                                                                CornerRadius="999"
                                                                Padding="8,4"
                                                                HorizontalAlignment="Left">
                                                            <TextBlock Text="{x:Bind Status, Mode=OneWay}"
                                                                       FontSize="12"
                                                                       FontWeight="SemiBold"
                                                                       Foreground="{x:Bind StatusColor, Mode=OneWay, Converter={StaticResource StringToBrushConverter}}"/>
                                                        </Border>
                                                    </Grid>
                                                </DataTemplate>
                                            </ItemsRepeater.ItemTemplate>
                                        </ItemsRepeater>
                                    </ScrollViewer>

                                    <!-- Pagination Control -->
                                    <Border Grid.Row="2"
                                            Margin="0,16,0,0"
                                            Padding="16,12"
                                            Background="Transparent"
                                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                            BorderThickness="0,1,0,0">
                                        <pagination:PaginationControl
                                            CurrentPage="{x:Bind ViewModel.CurrentPage, Mode=TwoWay}"
                                            TotalItems="{x:Bind ViewModel.TotalItems, Mode=OneWay}"
                                            PageSize="{x:Bind ViewModel.PageSize, Mode=TwoWay}"
                                            PageChanged="OnPageChanged"/>
                                    </Border>
                                </Grid>
                            </cards:DataTableCard.TableContent>
                        </cards:DataTableCard>

                    </StackPanel>
                </ScrollViewer>
            </RefreshContainer>
        </Grid>

        <!-- Layer 1: Loading Overlay (Shown during loading) -->
        <Grid x:Name="LoadingOverlay"
              Background="{ThemeResource LayerFillColorDefaultBrush}"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="24"
                        Padding="48">
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                              Width="64"
                              Height="64"/>
                <TextBlock Text="Loading earnings data..."
                           FontSize="18"
                           FontWeight="SemiBold"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Please wait while we fetch your commission details"
                           FontSize="14"
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
