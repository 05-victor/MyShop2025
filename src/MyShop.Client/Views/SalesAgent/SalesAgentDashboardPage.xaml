<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Client.Views.SalesAgent.SalesAgentDashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:MyShop.Client.ViewModels.SalesAgent"
    xmlns:cards="using:MyShop.Client.Views.Components.Cards"
    xmlns:charts="using:MyShop.Client.Views.Components.Charts"
    xmlns:layout="using:MyShop.Client.Views.Components.Layout"
    xmlns:buttons="using:MyShop.Client.Views.Components.Buttons"
    xmlns:converters="using:MyShop.Client.Common.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource LayerFillColorDefaultBrush}"
    x:Name="MyPage">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
    </Page.Resources>

    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="ResponsiveStates">
                
                <!-- Large Desktop: 1920px+ -->
                <VisualState x:Name="LargeDesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1920"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="40"/>
                        <Setter Target="KPIGrid.ColumnSpacing" Value="24"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Desktop: 1280-1919px -->
                <VisualState x:Name="DesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1280"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="32"/>
                        <Setter Target="KPIGrid.ColumnSpacing" Value="20"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet: 960-1279px -->
                <VisualState x:Name="TabletState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="960"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="24"/>
                        <Setter Target="KPIGrid.ColumnSpacing" Value="16"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet Portrait: 640-959px -->
                <VisualState x:Name="TabletPortraitState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="20"/>
                        <Setter Target="KPIGrid.ColumnSpacing" Value="12"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Mobile: 0-639px (Default) -->
                <VisualState x:Name="MobileState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding" Value="16"/>
                        <Setter Target="KPIGrid.ColumnSpacing" Value="8"/>
                    </VisualState.Setters>
                </VisualState>
                
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <!-- Layer 0: Dashboard Content (Hidden during loading) -->
        <Grid x:Name="DashboardContent"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <Grid.Transitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="50"/>
                </TransitionCollection>
            </Grid.Transitions>
            <RefreshContainer RefreshRequested="RefreshContainer_RefreshRequested">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <Grid x:Name="MainContent" Padding="24"
                          RowSpacing="16">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Page Header Section -->
                        <StackPanel Grid.Row="0"
                                    Spacing="16">

                            <!-- Email Verification Warning -->
                            <InfoBar
                                Severity="Warning"
                                Title="Email Verification Required"
                                Message="Please verify your email to start selling products"
                                IsOpen="{x:Bind ViewModel.IsVerified, Mode=OneWay, Converter={StaticResource InverseBoolConverter}}"
                                IsClosable="False">
                                <InfoBar.ActionButton>
                                    <Button Content="Resend Email"
                                            Style="{StaticResource PrimaryButtonStyle}"/>
                                </InfoBar.ActionButton>
                            </InfoBar>

                            <!-- Page Header -->
                            <layout:PageHeader
                                Title="Sales Agent Dashboard"
                                Subtitle="Track your sales performance and commissions">
                                <layout:PageHeader.ActionContent>
                                    <StackPanel Orientation="Horizontal"
                                                Spacing="12">
                                        <ComboBox Width="180"
                                                  Height="40"
                                                  CornerRadius="10"
                                                  BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}"
                                                  ItemsSource="{x:Bind ViewModel.DateRangeOptions}"
                                                  SelectedIndex="{x:Bind ViewModel.SelectedDateRangeIndex, Mode=TwoWay}"
                                                  AutomationProperties.Name="Select date range"
                                                  AutomationProperties.HelpText="Choose the time period for sales data"
                                                  UseSystemFocusVisuals="True"/>

                                        <buttons:IconButton
                                            Variant="Filled"
                                            IconGlyph="&#xE896;"
                                            Text="Export"
                                            Command="{x:Bind ViewModel.ExportCommand}"/>
                                    </StackPanel>
                                </layout:PageHeader.ActionContent>
                            </layout:PageHeader>

                        </StackPanel>

                        <!-- Main Content -->
                        <StackPanel Grid.Row="1"
                                    Spacing="20">

                            <!-- KPI Cards -->
                            <Grid x:Name="KPIGrid" ColumnSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Total Products KPI -->
                                <cards:KPICard
                                    Grid.Column="0"
                                    Title="Total Products"
                                    Icon="&#xE7B8;"
                                    Value="{x:Bind ViewModel.TotalProducts, Mode=OneWay}"
                                    Subtitle="Products listed"
                                    ShowBadge="Collapsed"/>

                                <!-- Total Sales KPI -->
                                <cards:KPICard
                                    Grid.Column="1"
                                    Title="Total Sales"
                                    Icon="&#xE7BF;"
                                    Value="{x:Bind ViewModel.TotalSales, Mode=OneWay}"
                                    Subtitle="Orders completed"
                                    ShowBadge="Visible"
                                    TrendIcon="&#xE74E;"
                                    TrendText="+8.5%"
                                    IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                    IconForegroundBrush="{ThemeResource PrimaryBrush}"
                                    BadgeBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                    BadgeForegroundBrush="{ThemeResource PrimaryBrush}"/>

                                <!-- Commission KPI -->
                                <cards:KPICard
                                    Grid.Column="2"
                                    Title="Commission Earned"
                                    Icon="&#xE7DB;"
                                    Value="{x:Bind ViewModel.TotalCommission, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                    Subtitle="This month"
                                    ShowBadge="Visible"
                                    TrendIcon="&#xE74E;"
                                    TrendText="{x:Bind ViewModel.ThisWeekCommission, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                    IconBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                    IconForegroundBrush="{ThemeResource SuccessGreenBrush}"
                                    BadgeBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                    BadgeForegroundBrush="{ThemeResource SuccessGreenBrush}"/>

                                <!-- Total Revenue KPI -->
                                <cards:KPICard
                                    Grid.Column="3"
                                    Title="Total Revenue"
                                    Icon="&#xE8EC;"
                                    Value="{x:Bind ViewModel.TotalRevenue, Mode=OneWay, Converter={StaticResource CurrencyConverter}}"
                                    Subtitle="Sales generated"
                                    ShowBadge="Visible"
                                    TrendIcon="&#xE74E;"
                                    TrendText="+15.2%"
                                    IconBackgroundBrush="{ThemeResource PurpleLightBrush}"
                                    IconForegroundBrush="{ThemeResource PurpleBrush}"
                                    BadgeBackgroundBrush="{ThemeResource PurpleLightBrush}"
                                    BadgeForegroundBrush="{ThemeResource PurpleBrush}"/>
                            </Grid>

                            <!-- Charts Row -->
                            <Grid ColumnSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Revenue Trend Chart (Same as Admin - using LineChartCard) -->
                                <charts:LineChartCard Grid.Column="0"
                                                      Title="Revenue &amp; Commission Trend"
                                                      Series="{x:Bind ViewModel.RevenueSeries, Mode=OneWay}"
                                                      ChartHeight="300"
                                                      ShowLegend="Visible"
                                                      ShowLegend2="Visible"
                                                      Legend1Text="Revenue"
                                                      Legend2Text="Commission"
                                                      ShowMenu="Visible"
                                                      RefreshRequested="LineChart_RefreshRequested"
                                                      ExportRequested="LineChart_ExportRequested"/>

                                <!-- Top Performing Links -->
                                <Border Grid.Column="1"
                                        Style="{StaticResource CardWithShadowStyle}">
                                    <StackPanel Spacing="16">
                                        <TextBlock Text="Top Performing Links"
                                                   FontSize="18"
                                                   FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>

                                        <!-- Changed to {Binding} for async loaded API data -->
                                        <ListView ItemsSource="{Binding TopLinks, Mode=OneWay}"
                                                  SelectionMode="None">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:TopAffiliateLink">
                                                    <Border Padding="0,12"
                                                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                            BorderThickness="0,0,0,1">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>

                                                            <TextBlock Grid.Row="0"
                                                                       Text="{x:Bind Product}"
                                                                       FontSize="14"
                                                                       FontWeight="SemiBold"
                                                                       Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                       TextTrimming="CharacterEllipsis"/>

                                                            <Grid Grid.Row="1"
                                                                  Margin="0,4,0,0">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>

                                                                <StackPanel Grid.Column="0"
                                                                            Orientation="Horizontal"
                                                                            Spacing="12">
                                                                    <TextBlock FontSize="12"
                                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                        <Run Text="{x:Bind Orders}"/>
                                                        <Run Text=" orders"/>
                                                                    </TextBlock>
                                                                    <TextBlock FontSize="12"
                                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                                                        <Run Text="{x:Bind Clicks}"/>
                                                        <Run Text=" clicks"/>
                                                                    </TextBlock>
                                                                </StackPanel>

                                                                <TextBlock Grid.Column="1"
                                                                           FontSize="14"
                                                                           FontWeight="Bold"
                                                                           Foreground="{ThemeResource SuccessGreenBrush}">
                                                           <Run Text="{x:Bind Commission, Converter={StaticResource CurrencyConverter}}"/>
                                                                </TextBlock>
                                                            </Grid>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Recent Orders Table -->
                            <cards:DataTableCard Title="Recent Orders"
                                                 ViewAllText="View All Orders"
                                                 ShowViewAll="Visible"
                                                 ViewAllCommand="{x:Bind ViewModel.ViewAllOrdersCommand}">
                                <cards:DataTableCard.TableContent>
                                    <!-- Changed to {Binding} for async loaded API data -->
                                    <ListView ItemsSource="{Binding RecentOrders, Mode=OneWay}"
                                              SelectionMode="None"
                                              MaxHeight="400">
                                        <ListView.Header>
                                            <Grid Padding="0,0,0,12"
                                                  BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                  BorderThickness="0,0,0,1">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="120"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="100"/>
                                                    <ColumnDefinition Width="100"/>
                                                    <ColumnDefinition Width="100"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Column="0"
                                                           Text="ORDER ID"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Grid.Column="1"
                                                           Text="CUSTOMER"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Grid.Column="2"
                                                           Text="PRODUCT"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Grid.Column="3"
                                                           Text="DATE"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Grid.Column="4"
                                                           Text="AMOUNT"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Grid.Column="5"
                                                           Text="STATUS"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                            </Grid>
                                        </ListView.Header>

                                        <ListView.ItemTemplate>
                                            <DataTemplate x:DataType="viewmodels:RecentSalesOrder">
                                                <Grid Padding="0,12"
                                                      BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                      BorderThickness="0,0,0,1">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="120"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="100"/>
                                                        <ColumnDefinition Width="100"/>
                                                        <ColumnDefinition Width="100"/>
                                                    </Grid.ColumnDefinitions>

                                                    <TextBlock Grid.Column="0"
                                                               Text="{x:Bind OrderId}"
                                                               FontSize="13"
                                                               FontFamily="Consolas"
                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                                                    <TextBlock Grid.Column="1"
                                                               Text="{x:Bind Customer}"
                                                               FontSize="14"
                                                               Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>

                                                    <TextBlock Grid.Column="2"
                                                               Text="{x:Bind Product}"
                                                               FontSize="14"
                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                               TextTrimming="CharacterEllipsis"/>

                                                    <TextBlock Grid.Column="3"
                                                               Text="{x:Bind OrderDate}"
                                                               FontSize="13"
                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>

                                                    <TextBlock Grid.Column="4"
                                                               FontSize="14"
                                                               FontWeight="SemiBold"
                                                               Foreground="{ThemeResource TextFillColorPrimaryBrush}">
                                        <Run Text="{x:Bind Amount, Converter={StaticResource CurrencyConverter}}"/>
                                                    </TextBlock>

                                                    <Border Grid.Column="5"
                                                            Background="{ThemeResource InfoBlueLightBrush}"
                                                            CornerRadius="999"
                                                            Padding="8,4"
                                                            HorizontalAlignment="Left">
                                                        <TextBlock Text="{x:Bind Status}"
                                                                   FontSize="12"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{ThemeResource DarkBlueBrush}"/>
                                                    </Border>
                                                </Grid>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>

                                        <ListView.ItemContainerStyle>
                                            <Style TargetType="ListViewItem">
                                                <Setter Property="Padding"
                                                        Value="0"/>
                                                <Setter Property="Margin"
                                                        Value="0"/>
                                                <Setter Property="HorizontalContentAlignment"
                                                        Value="Stretch"/>
                                            </Style>
                                        </ListView.ItemContainerStyle>
                                    </ListView>
                                </cards:DataTableCard.TableContent>
                            </cards:DataTableCard>

                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </RefreshContainer>
        </Grid>

        <!-- Layer 1: Loading Overlay (Shown during loading) -->
        <Grid x:Name="LoadingOverlay"
              Background="{ThemeResource LayerFillColorDefaultBrush}"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="24"
                        Padding="48">
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                              Width="64"
                              Height="64"/>
                <TextBlock Text="Loading dashboard data..."
                           FontSize="18"
                           FontWeight="SemiBold"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Please wait while we fetch your analytics"
                           FontSize="14"
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
