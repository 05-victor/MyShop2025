<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="MyShop.Client.Views.Components.Chat.ChatFlyout"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:MyShop.Shared.Models"
    Width="350" Height="500">
    
    <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
          CornerRadius="12"
          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
          BorderThickness="1">
        
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Grid Grid.Row="0" Padding="16,12">
            <TextBlock Text="Chat with AI Assistant"
                       FontSize="16"
                       FontWeight="SemiBold"
                       Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
        </Grid>
        
        <Border Grid.Row="0" 
                Height="1" 
                Background="{ThemeResource CardStrokeColorDefaultBrush}"
                VerticalAlignment="Bottom"/>
        
        <!-- Message History -->
        <ScrollViewer x:Name="MessageScrollViewer"
                      Grid.Row="1"
                      Padding="16,8"
                      VerticalScrollBarVisibility="Auto">
            <ItemsRepeater ItemsSource="{x:Bind ViewModel.Messages, Mode=OneWay}">
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate x:DataType="models:ChatMessage">
                        <Grid Margin="0,4">
                            <!-- User Message (Right) -->
                            <Border HorizontalAlignment="Right"
                                    MaxWidth="250"
                                    Visibility="{x:Bind Sender, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=User}">
                                <Border Background="{ThemeResource AccentFillColorDefaultBrush}"
                                        CornerRadius="12,12,0,12"
                                        Padding="12">
                                    <TextBlock Text="{x:Bind Content}"
                                               Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                                               TextWrapping="Wrap"
                                               FontSize="14"/>
                                </Border>
                            </Border>
                            
                            <!-- Bot Message (Left) -->
                            <Border HorizontalAlignment="Left"
                                    MaxWidth="250"
                                    Visibility="{x:Bind Sender, Converter={StaticResource EnumToVisibilityConverter}, ConverterParameter=Bot}">
                                <Border Background="{ThemeResource ControlFillColorSecondaryBrush}"
                                        CornerRadius="12,12,12,0"
                                        Padding="12">
                                    <TextBlock Text="{x:Bind Content}"
                                               Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                               TextWrapping="Wrap"
                                               FontSize="14"/>
                                </Border>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
        </ScrollViewer>
        
        <Border Grid.Row="1" 
                Height="1" 
                Background="{ThemeResource CardStrokeColorDefaultBrush}"
                VerticalAlignment="Bottom"/>
        
        <!-- Input Area -->
        <Grid Grid.Row="2" Padding="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBox Grid.Column="0"
                     PlaceholderText="Type your message..."
                     Text="{x:Bind ViewModel.CurrentMessage, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     IsEnabled="{x:Bind ViewModel.CanSend, Mode=OneWay}"
                     CornerRadius="20"
                     Padding="12,8"
                     BorderThickness="1"/>
            
            <Button Grid.Column="1"
                    Margin="8,0,0,0"
                    Width="40" Height="40"
                    CornerRadius="20"
                    Background="{ThemeResource AccentFillColorDefaultBrush}"
                    Command="{x:Bind ViewModel.SendMessageCommand}"
                    IsEnabled="{x:Bind ViewModel.CanSend, Mode=OneWay}">
                
                <Grid>
                    <FontIcon Glyph="&#xE724;" 
                              FontSize="16"
                              Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                              Visibility="{x:Bind ViewModel.IsSending, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                    
                    <ProgressRing IsActive="True" 
                                  Width="20" Height="20"
                                  Foreground="{ThemeResource TextOnAccentFillColorPrimaryBrush}"
                                  Visibility="{x:Bind ViewModel.IsSending, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </Grid>
            </Button>
        </Grid>
    </Grid>
</UserControl>
