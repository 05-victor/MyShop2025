<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Client.Views.Admin.AdminDashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:MyShop.Client.ViewModels.Admin"
    xmlns:badges="using:MyShop.Client.Views.Components.Badges"
    xmlns:cards="using:MyShop.Client.Views.Components.Cards"
    xmlns:charts="using:MyShop.Client.Views.Components.Charts"
    xmlns:layout="using:MyShop.Client.Views.Components.Layout"
    xmlns:buttons="using:MyShop.Client.Views.Components.Buttons"
    mc:Ignorable="d"
    Background="{ThemeResource PageBackgroundBrush}"
    x:Name="MyPage">

    <Page.Transitions>
        <TransitionCollection>
            <EntranceThemeTransition FromVerticalOffset="50"/>
        </TransitionCollection>
    </Page.Transitions>

    <!-- Note: Converters are already merged in App.xaml -> Generic.xaml -->
    <!-- No need to merge them again here to avoid circular dependency -->

    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="ResponsiveStates">

                <!-- Large Desktop: 1920px+ -->
                <VisualState x:Name="LargeDesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1920"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="40"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="24"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Desktop: 1280-1919px -->
                <VisualState x:Name="DesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1280"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="32"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="20"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet: 960-1279px -->
                <VisualState x:Name="TabletState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="960"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="24"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="16"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet Portrait: 640-959px -->
                <VisualState x:Name="TabletPortraitState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="20"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="12"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Mobile: 0-639px (Default) -->
                <VisualState x:Name="MobileState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="16"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="8"/>
                    </VisualState.Setters>
                </VisualState>

            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <!-- Layer 0: Dashboard Content (Hidden during loading) -->
        <Grid x:Name="DashboardContent"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <Grid.Transitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="50"/>
                </TransitionCollection>
            </Grid.Transitions>
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          Background="{ThemeResource PageBackgroundBrush}">
                <Grid x:Name="MainContent"
                      Padding="24"
                      RowSpacing="16"
                      Background="{ThemeResource PageBackgroundBrush}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Page Header -->
                    <layout:PageHeader
                        Title="Admin Dashboard"
                        Subtitle="Platform-wide overview and analytics">
                        <layout:PageHeader.ActionContent>
                            <StackPanel Orientation="Horizontal"
                                        Spacing="12">
                                <!-- Period Selector -->
                                <ComboBox x:Name="PeriodComboBox"
                                          Width="180"
                                          Height="40"
                                          SelectedIndex="2"
                                          CornerRadius="8"
                                          AutomationProperties.Name="Select time period"
                                          AutomationProperties.HelpText="Choose the reporting period for dashboard data"
                                          UseSystemFocusVisuals="True"
                                          SelectionChanged="PeriodComboBox_SelectionChanged">
                                    <ComboBoxItem Content="Day"
                                                  Tag="day"/>
                                    <ComboBoxItem Content="Week"
                                                  Tag="week"/>
                                    <ComboBoxItem Content="Month"
                                                  Tag="month"
                                                  IsSelected="True"/>
                                    <ComboBoxItem Content="Year"
                                                  Tag="year"/>
                                </ComboBox>

                                <!-- Export Button with Dropdown -->
                                <Button
                                    MinWidth="130"
                                    Padding="16,0"
                                    Style="{StaticResource SecondaryButtonSmallStyle}"
                                    ToolTipService.ToolTip="Export dashboard data">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE898;" FontSize="{StaticResource FontSize_Base}"/>
                                        <TextBlock Text="Export"/>
                                        <FontIcon Glyph="&#xE70D;" FontSize="{StaticResource FontSize_XS}"/>
                                    </StackPanel>
                                    <Button.Flyout>
                                        <MenuFlyout Placement="Bottom">
                                            <MenuFlyoutItem Text="Export to CSV" 
                                                            Click="ExportCsvButton_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xE9F9;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                            <MenuFlyoutItem Text="Export to PDF" 
                                                            Click="ExportPdfButton_Click">
                                                <MenuFlyoutItem.Icon>
                                                    <FontIcon Glyph="&#xEA90;"/>
                                                </MenuFlyoutItem.Icon>
                                            </MenuFlyoutItem>
                                        </MenuFlyout>
                                    </Button.Flyout>
                                </Button>
                            </StackPanel>
                        </layout:PageHeader.ActionContent>
                    </layout:PageHeader>

                    <!-- Main Content -->
                    <StackPanel Grid.Row="1"
                                Spacing="20">
                        <!-- Statistics Cards (KPICard Components) -->
                        <Border Style="{StaticResource CardWithShadowStyle}">
                            <Grid x:Name="KPIGrid"
                                  ColumnSpacing="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Total GMV This Month KPI -->
                            <cards:KPICard
                                Grid.Column="0"
                                Title="Total GMV This Month"
                                Icon="&#xE7DB;"
                                Value="{x:Bind ViewModel.TotalGmvThisMonth, Mode=OneWay}"
                                IsCurrency="True"
                                Subtitle="Total sales across platform"
                                ShowBadge="Visible"
                                TrendIcon="&#xE74E;"
                                TrendText="Revenue"
                                IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                IconForegroundBrush="{ThemeResource PrimaryBrush}"
                                BadgeBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                BadgeForegroundBrush="{ThemeResource PrimaryBrush}"/>

                            <!-- Admin Commission KPI -->
                            <cards:KPICard
                                Grid.Column="1"
                                Title="Admin Commission"
                                Icon="&#xE8D0;"
                                Value="{x:Bind ViewModel.AdminCommission, Mode=OneWay}"
                                IsCurrency="True"
                                Subtitle="5% of total GMV"
                                ShowBadge="Visible"
                                TrendIcon="&#xE8D0;"
                                TrendText="Earnings"
                                IconBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                IconForegroundBrush="{ThemeResource SuccessGreenBrush}"
                                BadgeBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                BadgeForegroundBrush="{ThemeResource SuccessGreenBrush}"/>

                            <!-- Active SalesAgents KPI -->
                            <cards:KPICard
                                Grid.Column="2"
                                Title="Active SalesAgents"
                                Icon="&#xE716;"
                                Value="{x:Bind ViewModel.ActiveSalesAgents, Mode=OneWay}"
                                Subtitle="Approved and selling"
                                ShowBadge="Visible"
                                TrendIcon="&#xE716;"
                                TrendText="Sellers"
                                IconBackgroundBrush="{ThemeResource WarningAmberLightBrush}"
                                IconForegroundBrush="{ThemeResource WarningAmberBrush}"
                                BadgeBackgroundBrush="{ThemeResource WarningAmberLightBrush}"
                                BadgeForegroundBrush="{ThemeResource WarningAmberBrush}"/>

                            <!-- Items To Review KPI -->
                            <cards:KPICard
                                Grid.Column="3"
                                Title="Items To Review"
                                Icon="&#xE7BA;"
                                Value="{x:Bind ViewModel.ItemsToReview, Mode=OneWay}"
                                Subtitle="Flagged products pending review"
                                ShowBadge="Visible"
                                TrendIcon="&#xE7BA;"
                                TrendText="Moderate"
                                IconBackgroundBrush="{ThemeResource ErrorRedLightBrush}"
                                IconForegroundBrush="{ThemeResource ErrorRedBrush}"
                                BadgeBackgroundBrush="{ThemeResource ErrorRedLightBrush}"
                                BadgeForegroundBrush="{ThemeResource ErrorRedBrush}"/>
                            </Grid>
                        </Border>

                        <!-- Charts Section -->
                        <Border Style="{StaticResource CardWithShadowStyle}">
                            <charts:LineChartCard
                                              Title="Revenue &amp; Commission Trend"
                                              Series="{x:Bind ViewModel.RevenueSeries, Mode=OneWay}"
                                              YAxes="{x:Bind ViewModel.YAxes, Mode=OneWay}"
                                              ChartHeight="320"
                                              ShowLegend="Visible"
                                              ShowLegend2="Visible"
                                              Legend1Text="Revenue"
                                              Legend2Text="Commission"
                                              ShowMenu="Visible"/>
                        </Border>

                        <!-- Detail Row - Top SalesAgents & Top Selling Products Tables -->
                        <Grid ColumnSpacing="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Top SalesAgents Table -->
                            <cards:DataTableCard Grid.Column="0"
                                                 Title="Top SalesAgents"
                                                 ShowViewAll="Visible"
                                                 ViewAllText="View All"
                                                 ViewAllClicked="ViewAllAgents_Click">
                                <cards:DataTableCard.TableContent>
                                    <StackPanel Spacing="0">
                                        <!-- Top SalesAgents Table Header -->
                                        <Grid Padding="0,0,0,12"
                                              BorderBrush="{ThemeResource CardStrokeBrush}"
                                              BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="40"/>
                                                <ColumnDefinition Width="1.5*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="1"
                                                       Text="EMAIL"
                                                       FontSize="{StaticResource FontSize_SM}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Column="2"
                                                       Text="GMV"
                                                       FontSize="{StaticResource FontSize_SM}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Column="3"
                                                       Text="COMMISSION"
                                                       FontSize="{StaticResource FontSize_SM}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextSecondaryBrush}"/>
                                        </Grid>

                                        <!-- Top SalesAgents List -->
                                        <ListView ItemsSource="{x:Bind ViewModel.TopSalesAgents, Mode=OneWay}"
                                                  SelectionMode="None">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:TopSalesAgentItem">
                                                    <Grid Padding="16"
                                                          BorderBrush="{ThemeResource CardStrokeBrush}"
                                                          BorderThickness="0,0,0,1">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="40"/>
                                                            <ColumnDefinition Width="1.5*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Avatar -->
                                                        <PersonPicture Grid.Column="0"
                                                                       ProfilePicture="{x:Bind Avatar, Converter={StaticResource StringToImageSourceConverter}}"
                                                                       DisplayName="{x:Bind Name}"
                                                                       Width="32"
                                                                       Height="32"/>

                                                        <!-- Email -->
                                                        <TextBlock Grid.Column="1"
                                                                   Text="{x:Bind Email}"
                                                                   FontSize="{StaticResource FontSize_Base}"
                                                                   Foreground="{ThemeResource TextSecondaryBrush}"
                                                                   VerticalAlignment="Center"/>

                                                        <!-- GMV -->
                                                        <TextBlock Grid.Column="2"
                                                                   Text="{x:Bind GMV, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="{StaticResource FontSize_Base}"
                                                                   Foreground="{ThemeResource TextPrimaryBrush}"
                                                                   VerticalAlignment="Center"/>

                                                        <!-- Commission -->
                                                        <TextBlock Grid.Column="3"
                                                                   Text="{x:Bind Commission, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="{StaticResource FontSize_Base}"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{ThemeResource SuccessGreenBrush}"
                                                                   VerticalAlignment="Center"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>
                                    </StackPanel>
                                </cards:DataTableCard.TableContent>
                            </cards:DataTableCard>

                            <!-- Flagged Products Table -->
                            <cards:DataTableCard Grid.Column="1"
                                                 Title="Top Selling Products"
                                                 ShowViewAll="Visible"
                                                 ViewAllText="View All"
                                                 ViewAllClicked="ViewAllProducts_Click">
                                <cards:DataTableCard.TableContent>
                                    <StackPanel Spacing="0">
                                        <!-- Table Header -->
                                        <Grid Padding="0,0,0,12"
                                              BorderBrush="{ThemeResource CardStrokeBrush}"
                                              BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="1*"/>
                                                <ColumnDefinition Width="2*"/>
                                                <ColumnDefinition Width="1*"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="0"
                                                       Text="IMAGE"
                                                       FontSize="{StaticResource FontSize_SM}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="NAME"
                                                       FontSize="{StaticResource FontSize_SM}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Column="2"
                                                       Text="SOLD"
                                                       FontSize="{StaticResource FontSize_SM}"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextSecondaryBrush}"/>
                                        </Grid>

                                        <!-- Top Selling Products List -->
                                        <ListView ItemsSource="{x:Bind ViewModel.TopProducts, Mode=OneWay}"
                                                  SelectionMode="None">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:TopProductItem">
                                                    <Grid Padding="16"
                                                          BorderBrush="{ThemeResource CardStrokeBrush}"
                                                          BorderThickness="0,0,0,1">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="1*"/>
                                                            <ColumnDefinition Width="2*"/>
                                                            <ColumnDefinition Width="1*"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Product Image -->
                                                        <Border
                                                            Grid.Column="0"
                                                            Width="48"
                                                            Height="48"
                                                            HorizontalAlignment="Left"
                                                            Background="{ThemeResource CardStrokeBrush}"
                                                            CornerRadius="8">
                                                            <Image Stretch="UniformToFill">
                                                                <Image.Source>
                                                                    <BitmapImage UriSource="{x:Bind ImageUrl}"
                                                                                 DecodePixelWidth="96"
                                                                                 DecodePixelType="Logical"/>
                                                                </Image.Source>
                                                            </Image>
                                                        </Border>

                                                        <!-- Product Name -->
                                                        <TextBlock Grid.Column="1"
                                                                   Text="{x:Bind Name}"
                                                                   FontSize="{StaticResource FontSize_Base}"
                                                                   Foreground="{ThemeResource TextPrimaryBrush}"
                                                                   VerticalAlignment="Center"
                                                                   TextWrapping="Wrap"
                                                                   Margin="4,0,0,0"/>

                                                        <!-- Number Sold -->
                                                        <TextBlock Grid.Column="2"
                                                                   Text="{x:Bind SoldCount}"
                                                                   FontSize="{StaticResource FontSize_Base}"
                                                                   Foreground="{ThemeResource TextPrimaryBrush}"
                                                                   VerticalAlignment="Center"
                                                                   HorizontalAlignment="Center"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>
                                    </StackPanel>
                                </cards:DataTableCard.TableContent>
                            </cards:DataTableCard>
                        </Grid>

                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- Layer 1: Loading Overlay (Shown during loading) -->
        <Grid x:Name="LoadingOverlay"
              Background="{ThemeResource PageBackgroundBrush}"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="24"
                        Padding="64">
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                              Width="64"
                              Height="64"/>
                <TextBlock Text="Loading dashboard data..."
                           FontSize="{StaticResource FontSize_XL}"
                           FontWeight="SemiBold"
                           Foreground="{ThemeResource TextSecondaryBrush}"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Please wait while we fetch your analytics"
                           FontSize="{StaticResource FontSize_Base}"
                           Foreground="{ThemeResource TextTertiaryBrush}"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>

