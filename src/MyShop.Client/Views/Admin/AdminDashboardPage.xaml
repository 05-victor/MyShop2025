<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShop.Client.Views.Admin.AdminDashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:MyShop.Client.ViewModels.Admin"
    xmlns:badges="using:MyShop.Client.Views.Components.Badges"
    xmlns:cards="using:MyShop.Client.Views.Components.Cards"
    xmlns:charts="using:MyShop.Client.Views.Components.Charts"
    xmlns:layout="using:MyShop.Client.Views.Components.Layout"
    xmlns:buttons="using:MyShop.Client.Views.Components.Buttons"
    mc:Ignorable="d"
    Background="{ThemeResource LayerFillColorDefaultBrush}"
    x:Name="MyPage">

    <Page.Transitions>
        <TransitionCollection>
            <EntranceThemeTransition FromVerticalOffset="50"/>
        </TransitionCollection>
    </Page.Transitions>

    <!-- Note: Converters are already merged in App.xaml -> Generic.xaml -->
    <!-- No need to merge them again here to avoid circular dependency -->

    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="ResponsiveStates">

                <!-- Large Desktop: 1920px+ -->
                <VisualState x:Name="LargeDesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1920"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="40"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="24"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Desktop: 1280-1919px -->
                <VisualState x:Name="DesktopState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1280"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="32"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="20"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet: 960-1279px -->
                <VisualState x:Name="TabletState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="960"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="24"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="16"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Tablet Portrait: 640-959px -->
                <VisualState x:Name="TabletPortraitState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="640"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="20"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="12"/>
                    </VisualState.Setters>
                </VisualState>

                <!-- Mobile: 0-639px (Default) -->
                <VisualState x:Name="MobileState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="MainContent.Padding"
                                Value="16"/>
                        <Setter Target="KPIGrid.ColumnSpacing"
                                Value="8"/>
                    </VisualState.Setters>
                </VisualState>

            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <!-- Layer 0: Dashboard Content (Hidden during loading) -->
        <Grid x:Name="DashboardContent"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <Grid.Transitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="50"/>
                </TransitionCollection>
            </Grid.Transitions>
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          Background="{ThemeResource LayerFillColorDefaultBrush}">
                <Grid x:Name="MainContent"
                      Padding="{StaticResource Padding_XL}"
                      RowSpacing="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Page Header -->
                    <layout:PageHeader
                        Title="Admin Dashboard"
                        Breadcrumb="Admin">
                        <layout:PageHeader.ActionContent>
                            <StackPanel Orientation="Horizontal"
                                        Spacing="12">
                                <!-- Period Selector -->
                                <ComboBox x:Name="PeriodComboBox"
                                          Width="180"
                                          Height="40"
                                          SelectedIndex="2"
                                          CornerRadius="8"
                                          AutomationProperties.Name="Select time period"
                                          AutomationProperties.HelpText="Choose the reporting period for dashboard data"
                                          UseSystemFocusVisuals="True"
                                          SelectionChanged="PeriodComboBox_SelectionChanged">
                                    <ComboBoxItem Content="Day"
                                                  Tag="day"/>
                                    <ComboBoxItem Content="Week"
                                                  Tag="week"/>
                                    <ComboBoxItem Content="Month"
                                                  Tag="month"
                                                  IsSelected="True"/>
                                    <ComboBoxItem Content="Year"
                                                  Tag="year"/>
                                </ComboBox>

                                <!-- Export Button -->
                                <buttons:IconButton
                                    Variant="Filled"
                                    IconGlyph="&#xE896;"
                                    Text="Export"
                                    Command="{x:Bind ViewModel.ExportDashboardCommand}"/>
                            </StackPanel>
                        </layout:PageHeader.ActionContent>
                    </layout:PageHeader>

                    <!-- Main Content -->
                    <StackPanel Grid.Row="1"
                                Spacing="20"
                                Margin="0,4,0,0">
                        <!-- Statistics Cards (KPICard Components) -->
                        <Grid x:Name="KPIGrid"
                              ColumnSpacing="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Total GMV This Month KPI -->
                            <cards:KPICard
                                Grid.Column="0"
                                Title="Total GMV This Month"
                                Icon="&#xE7DB;"
                                Value="{x:Bind ViewModel.TotalGmvThisMonth, Mode=OneWay}"
                                IsCurrency="True"
                                Subtitle="Total sales across platform"
                                ShowBadge="Visible"
                                TrendIcon="&#xE74E;"
                                TrendText="Revenue"
                                IconBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                IconForegroundBrush="{ThemeResource PrimaryBrush}"
                                BadgeBackgroundBrush="{ThemeResource InfoBlueLightBrush}"
                                BadgeForegroundBrush="{ThemeResource PrimaryBrush}"/>

                            <!-- Admin Commission KPI -->
                            <cards:KPICard
                                Grid.Column="1"
                                Title="Admin Commission"
                                Icon="&#xE8D0;"
                                Value="{x:Bind ViewModel.AdminCommission, Mode=OneWay}"
                                IsCurrency="True"
                                Subtitle="5% of total GMV"
                                ShowBadge="Visible"
                                TrendIcon="&#xE8D0;"
                                TrendText="Earnings"
                                IconBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                IconForegroundBrush="{ThemeResource SuccessGreenBrush}"
                                BadgeBackgroundBrush="{ThemeResource SuccessGreenLightBrush}"
                                BadgeForegroundBrush="{ThemeResource SuccessGreenBrush}"/>

                            <!-- Active SalesAgents KPI -->
                            <cards:KPICard
                                Grid.Column="2"
                                Title="Active SalesAgents"
                                Icon="&#xE716;"
                                Value="{x:Bind ViewModel.ActiveSalesAgents, Mode=OneWay}"
                                Subtitle="Approved and selling"
                                ShowBadge="Visible"
                                TrendIcon="&#xE716;"
                                TrendText="Sellers"
                                IconBackgroundBrush="{ThemeResource WarningAmberLightBrush}"
                                IconForegroundBrush="{ThemeResource WarningAmberBrush}"
                                BadgeBackgroundBrush="{ThemeResource WarningAmberLightBrush}"
                                BadgeForegroundBrush="{ThemeResource WarningAmberBrush}"/>

                            <!-- Items To Review KPI -->
                            <cards:KPICard
                                Grid.Column="3"
                                Title="Items To Review"
                                Icon="&#xE7BA;"
                                Value="{x:Bind ViewModel.ItemsToReview, Mode=OneWay}"
                                Subtitle="Flagged products pending review"
                                ShowBadge="Visible"
                                TrendIcon="&#xE7BA;"
                                TrendText="Moderate"
                                IconBackgroundBrush="{ThemeResource ErrorRedLightBrush}"
                                IconForegroundBrush="{ThemeResource ErrorRedBrush}"
                                BadgeBackgroundBrush="{ThemeResource ErrorRedLightBrush}"
                                BadgeForegroundBrush="{ThemeResource ErrorRedBrush}"/>
                        </Grid>

                        <!-- Charts Section -->
                        <Grid ColumnSpacing="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Revenue & Commission Trend Chart -->
                            <charts:LineChartCard Grid.Column="0"
                                                  Title="Revenue &amp; Commission Trend"
                                                  Series="{x:Bind ViewModel.RevenueSeries, Mode=OneWay}"
                                                  YAxes="{x:Bind ViewModel.YAxes, Mode=OneWay}"
                                                  ChartHeight="320"
                                                  ShowLegend="Visible"
                                                  ShowLegend2="Visible"
                                                  Legend1Text="Revenue"
                                                  Legend2Text="Commission"
                                                  ShowMenu="Visible"/>

                            <!-- Sales by Category -->
                            <Border Grid.Column="1"
                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                    CornerRadius="8"
                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    Padding="{StaticResource Padding_XL}">
                                <Border.Shadow>
                                    <ThemeShadow/>
                                </Border.Shadow>
                                <StackPanel Spacing="16">
                                    <!-- Header with Toggle Buttons -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0"
                                                   Text="Top Sales"
                                                   FontSize="18"
                                                   FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                   VerticalAlignment="Center"/>

                                        <!-- Toggle Buttons -->
                                        <StackPanel Grid.Column="1"
                                                    Orientation="Horizontal"
                                                    Spacing="8"
                                                    VerticalAlignment="Center">
                                            <!-- Category Button -->
                                            <Button Content="Category"
                                                    Padding="{StaticResource ButtonPadding_SM}"
                                                    CornerRadius="8"
                                                    FontSize="13"
                                                    FontWeight="SemiBold"
                                                    Command="{x:Bind ViewModel.SwitchSalesViewCommand}"
                                                    CommandParameter="category"
                                                    Background="{x:Bind ViewModel.IsCategoryView, Mode=OneWay, Converter={StaticResource BoolToButtonBackgroundConverter}}"
                                                    Foreground="{x:Bind ViewModel.IsCategoryView, Mode=OneWay, Converter={StaticResource BoolToButtonForegroundConverter}}"
                                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                    BorderThickness="1"/>
                                        </StackPanel>
                                    </Grid>

                                    <!-- Sales by Category List -->
                                    <Grid Margin="0,8,0,0"
                                          Visibility="{x:Bind ViewModel.IsCategoryView, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <!-- Content when data is available -->
                                        <ListView ItemsSource="{x:Bind ViewModel.CategoryData, Mode=OneWay}"
                                                  SelectionMode="None"
                                                  Visibility="{x:Bind ViewModel.CategoryData.Count, Mode=OneWay, Converter={StaticResource InverseCountToVisibilityConverter}}">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:CategoryDataPoint">
                                                    <Grid Padding="{StaticResource Padding_MD}"
                                                          ColumnSpacing="16">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="55"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Category Name & Progress Bar -->
                                                        <StackPanel Grid.Column="0"
                                                                    Spacing="6"
                                                                    VerticalAlignment="Center">
                                                            <TextBlock Text="{x:Bind Name}"
                                                                       FontSize="14"
                                                                       FontWeight="Medium"
                                                                       Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                       TextWrapping="NoWrap"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                            <ProgressBar Value="{x:Bind Percentage}"
                                                                         Maximum="100"
                                                                         Height="8"
                                                                         CornerRadius="4"
                                                                         Foreground="{ThemeResource PrimaryBrush}"
                                                                         Background="{ThemeResource CardStrokeColorDefaultBrush}"/>
                                                        </StackPanel>

                                                        <!-- Percentage -->
                                                        <TextBlock Grid.Column="1"
                                                                   FontSize="15"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{ThemeResource PrimaryBrush}"
                                                                   HorizontalAlignment="Right"
                                                                   VerticalAlignment="Center"
                                                                   TextAlignment="Right">
                                                    <Run Text="{x:Bind Percentage}"/><Run Text="%"/>
                                                        </TextBlock>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="MinHeight"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>

                                        <!-- Empty State -->
                                        <StackPanel Visibility="{x:Bind ViewModel.CategoryData.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}}"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Spacing="12"
                                                    Padding="24">
                                            <FontIcon Glyph="&#xE9F9;"
                                                      FontSize="32"
                                                      Foreground="{ThemeResource Gray500Brush}"/>
                                            <TextBlock Text="No category data available"
                                                       FontSize="14"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                       HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>

                                    <!-- Sales by Agents View -->
                                    <Grid Margin="0,8,0,0"
                                          Visibility="{x:Bind ViewModel.IsAgentsView, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <!-- Content when data is available -->
                                        <ListView ItemsSource="{x:Bind ViewModel.TopSalesAgents, Mode=OneWay}"
                                                  SelectionMode="None"
                                                  Visibility="{x:Bind ViewModel.TopSalesAgents.Count, Mode=OneWay, Converter={StaticResource InverseCountToVisibilityConverter}}">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:TopSalesAgentItem">
                                                    <Grid Padding="{StaticResource Padding_MD}"
                                                          ColumnSpacing="16">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="75"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Agent Name & Avatar -->
                                                        <StackPanel Grid.Column="0"
                                                                    Orientation="Horizontal"
                                                                    Spacing="10"
                                                                    VerticalAlignment="Center">
                                                            <PersonPicture ProfilePicture="{x:Bind Avatar, Converter={StaticResource StringToImageSourceConverter}}"
                                                                           DisplayName="{x:Bind Name}"
                                                                           Width="32"
                                                                           Height="32"/>
                                                            <StackPanel VerticalAlignment="Center"
                                                                        Spacing="2">
                                                                <TextBlock Text="{x:Bind Name}"
                                                                           FontSize="14"
                                                                           FontWeight="Medium"
                                                                           Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                           TextWrapping="NoWrap"
                                                                           TextTrimming="CharacterEllipsis"/>
                                                                <StackPanel Orientation="Horizontal"
                                                                            Spacing="4">
                                                                    <FontIcon Glyph="&#xE735;"
                                                                              FontSize="10"
                                                                              Foreground="{ThemeResource WarningAmberBrush}"/>
                                                                    <TextBlock Text="{x:Bind Rating}"
                                                                               FontSize="11"
                                                                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                                                </StackPanel>
                                                            </StackPanel>
                                                        </StackPanel>

                                                        <!-- GMV Value -->
                                                        <TextBlock Grid.Column="1"
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{ThemeResource SuccessGreenBrush}"
                                                                   HorizontalAlignment="Right"
                                                                   VerticalAlignment="Center"
                                                                   TextAlignment="Right">
                                                    <Run Text="{x:Bind GMV, Converter={StaticResource CurrencyConverter}}"/>
                                                        </TextBlock>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="MinHeight"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>

                                        <!-- Empty State -->
                                        <StackPanel Visibility="{x:Bind ViewModel.TopSalesAgents.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}}"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Spacing="12"
                                                    Padding="{StaticResource Padding_XL}">
                                            <FontIcon Glyph="&#xE716;"
                                                      FontSize="32"
                                                      Foreground="{ThemeResource Gray500Brush}"/>
                                            <TextBlock Text="No agent data available"
                                                       FontSize="14"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                       HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </Grid>

                        <!-- Detail Row - Top SalesAgents & Flagged Products Tables -->
                        <Grid ColumnSpacing="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Top SalesAgents Table -->
                            <cards:DataTableCard Grid.Column="0"
                                                 Title="Top SalesAgents"
                                                 ShowViewAll="Visible"
                                                 ViewAllText="View All"
                                                 ViewAllClicked="ViewAllAgents_Click">
                                <cards:DataTableCard.TableContent>
                                    <StackPanel Spacing="0">
                                        <!-- Top SalesAgents Table Header -->
                                        <Grid Padding="0,0,0,12"
                                              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                              BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="40"/>
                                                <ColumnDefinition Width="1.5*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="1"
                                                       Text="EMAIL"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                            <TextBlock Grid.Column="2"
                                                       Text="GMV"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                            <TextBlock Grid.Column="3"
                                                       Text="COMMISSION"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Grid>

                                        <!-- Top SalesAgents List -->
                                        <ListView ItemsSource="{x:Bind ViewModel.TopSalesAgents, Mode=OneWay}"
                                                  SelectionMode="None">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:TopSalesAgentItem">
                                                    <Grid Padding="{StaticResource Padding_MD}"
                                                          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                          BorderThickness="0,0,0,1">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="40"/>
                                                            <ColumnDefinition Width="1.5*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Avatar -->
                                                        <PersonPicture Grid.Column="0"
                                                                       ProfilePicture="{x:Bind Avatar, Converter={StaticResource StringToImageSourceConverter}}"
                                                                       DisplayName="{x:Bind Name}"
                                                                       Width="32"
                                                                       Height="32"/>

                                                        <!-- Email -->
                                                        <TextBlock Grid.Column="1"
                                                                   Text="{x:Bind Email}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                   VerticalAlignment="Center"/>

                                                        <!-- GMV -->
                                                        <TextBlock Grid.Column="2"
                                                                   Text="{x:Bind GMV, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                   VerticalAlignment="Center"/>

                                                        <!-- Commission -->
                                                        <TextBlock Grid.Column="3"
                                                                   Text="{x:Bind Commission, Converter={StaticResource CurrencyConverter}}"
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="{ThemeResource SuccessGreenBrush}"
                                                                   VerticalAlignment="Center"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>
                                    </StackPanel>
                                </cards:DataTableCard.TableContent>
                            </cards:DataTableCard>

                            <!-- Flagged Products Table -->
                            <cards:DataTableCard Grid.Column="1"
                                                 Title="Top Selling Products"
                                                 ShowViewAll="Visible"
                                                 ViewAllText="View All"
                                                 ViewAllClicked="ViewAllProducts_Click">
                                <cards:DataTableCard.TableContent>
                                    <StackPanel Spacing="0">
                                        <!-- Table Header -->
                                        <Grid Padding="0,0,0,12"
                                              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                              BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="1*"/>
                                                <ColumnDefinition Width="2*"/>
                                                <ColumnDefinition Width="1*"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="0"
                                                       Text="IMAGE"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="NAME"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                            <TextBlock Grid.Column="2"
                                                       Text="SOLD"
                                                       FontSize="12"
                                                       FontWeight="SemiBold"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                        </Grid>

                                        <!-- Top Selling Products List -->
                                        <ListView ItemsSource="{x:Bind ViewModel.TopProducts, Mode=OneWay}"
                                                  SelectionMode="None">
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="viewmodels:TopProductItem">
                                                    <Grid Padding="{StaticResource Padding_MD}"
                                                          BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                          BorderThickness="0,0,0,1">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="1*"/>
                                                            <ColumnDefinition Width="2*"/>
                                                            <ColumnDefinition Width="1*"/>
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Product Image -->
                                                        <Border
                                                            Grid.Column="0"
                                                            Width="48"
                                                            Height="48"
                                                            HorizontalAlignment="Left"
                                                            Background="{ThemeResource CardStrokeColorDefaultBrush}"
                                                            CornerRadius="8">
                                                            <Image Stretch="UniformToFill">
                                                                <Image.Source>
                                                                    <BitmapImage UriSource="{x:Bind ImageUrl}"
                                                                                 DecodePixelWidth="96"
                                                                                 DecodePixelType="Logical"/>
                                                                </Image.Source>
                                                            </Image>
                                                        </Border>

                                                        <!-- Product Name -->
                                                        <TextBlock Grid.Column="1"
                                                                   Text="{x:Bind Name}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                   VerticalAlignment="Center"
                                                                   TextWrapping="Wrap"
                                                                   Margin="4,0,0,0"/>

                                                        <!-- Number Sold -->
                                                        <TextBlock Grid.Column="2"
                                                                   Text="{x:Bind SoldCount}"
                                                                   FontSize="14"
                                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                                   VerticalAlignment="Center"
                                                                   HorizontalAlignment="Center"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding"
                                                            Value="0"/>
                                                    <Setter Property="Margin"
                                                            Value="0"/>
                                                    <Setter Property="HorizontalContentAlignment"
                                                            Value="Stretch"/>
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                        </ListView>
                                    </StackPanel>
                                </cards:DataTableCard.TableContent>
                            </cards:DataTableCard>
                        </Grid>

                    </StackPanel>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- Layer 1: Loading Overlay (Shown during loading) -->
        <Grid x:Name="LoadingOverlay"
              Background="{ThemeResource LayerFillColorDefaultBrush}"
              Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Spacing="24"
                        Padding="{StaticResource Padding_3XL}">
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                              Width="64"
                              Height="64"/>
                <TextBlock Text="Loading dashboard data..."
                           FontSize="18"
                           FontWeight="SemiBold"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Please wait while we fetch your analytics"
                           FontSize="14"
                           Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>

